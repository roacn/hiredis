name: Build via CMake

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-hiredis:
    name: Build
    runs-on: windows-latest
    strategy:
      matrix:
        configration: [release, debug]
        build_shared_libs: [shared, static]
        arch: [x64, win32]

    steps:
      - uses: microsoft/setup-msbuild@main
      - uses: actions/checkout@v4
      
      - name: Run CMake
        run: |
          if ( "${{ matrix.build_shared_libs }}" -eq "shared" ) {
            cmake -A ${{ matrix.arch }} -Wno-dev CMakeLists.txt
          } else {
            cmake -A ${{ matrix.arch }} -Wno-dev CMakeLists.txt -DBUILD_SHARED_LIBS=OFF
          }
          
      - name: Build Hiredis
        id: build
        run: |
          if ( "${{ matrix.configration }}" -eq "release" ) {
            MSBuild hiredis.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.arch }}
          } else {
            MSBuild hiredis.vcxproj /p:Configuration=Debug /p:Platform=${{ matrix.arch }}
          }

      - name: Prepare Upload
        continue-on-error: true
        if: steps.build.outcome == 'success'
        run: |
          mkdir ${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}
          if ( "${{ matrix.configration }}" -eq "release" ) {
            Copy-Item .\Release\* .\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\ -Force
            Remove-item .\Release -Force -Recurse
          } else {
            Copy-Item .\Debug\* .\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\ -Force
            Remove-item .\Debug -Force -Recurse
          }

      - name: Release Hiredis
        continue-on-error: true
        if: steps.build.outcome == 'success'
        uses: ncipollo/release-action@main
        with:
          name: windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}
          tag: windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          removeArtifacts: true
          artifacts: "${{ github.workspace }}\\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\\*.*"
          
      - name: Upload Artifacts
        continue-on-error: true
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: "windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}"
          path:  |
            ${{ github.workspace }}
